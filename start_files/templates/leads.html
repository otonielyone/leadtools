<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Listings</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="static/css/leads_tab1.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    
</head>
<body>
    <div class="loader" id="loader">
        <div class="spinner"></div>
        <div class="loading-message"><br>Retrieving leads...</div>    
    </div>

    <div class="container">
        <h1 class="banner">LEADTOOLS</h1>

        <!-- Leads Section -->
        <div id="tab1" class="tab-content active">
            <form id="leadsForm" action="/api/populate_leads_database" method="get">
                <button class="get" type="submit" id="startButton">Generate New Leads</button>
            </form>

            <!-- Toggle buttons for sections -->
            <button id="toggle-possible-lead">Possible Lead</button>
            <div id="possible-lead-list" style="display: none;">
                <div class="section-actions">
                    <button class="add-to-kvcore-btn" data-section="possible_leads">Add to KVCore</button>
                    <button class="delete-selected-btn" data-section="possible_leads">Delete</button>
                </div>
                <table border="1">
                    <thead>
                        <tr>
                            <th class="checkbox-column"><input type="checkbox" class="select-all" data-section="possible_leads"></th>
                            <th>Customer Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in possible_entries %}
                            <tr>
                                <td><input type="checkbox" class="entry-checkbox" data-section="possible_leads" data-entry-id="{{ entry.customer_id }}"></td>
                                <td>{{ entry.customer_name }}</td>
                                <td>{{ entry.customer_email if entry.customer_email else 'no email found' }}</td>
                                <td>{{ entry.customer_phone }}</td>
                                <td>{{ entry.customer_notes }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <button id="toggle-no-lead">No Lead</button>
            <div id="no-lead-list" style="display: none;">
                <div class="section-actions">
                    <button class="add-to-kvcore-btn" data-section="possible-leads">Add KVCore</button>
                    <button class="delete-selected-btn" data-section="possible-leads">Delete</button>
                </div>
                <table border="1">
                    <thead>
                        <tr>
                            <th class="checkbox-column"><input type="checkbox" class="select-all" data-section="no_leads"></th>
                            <th>Customer Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in no_answer_entries %}
                            <tr>
                                <td><input type="checkbox" class="entry-checkbox" data-section="no_leads" data-entry-id="{{ entry.customer_id }}"></td>
                                <td>{{ entry.customer_name }}</td>
                                <td>{{ entry.customer_email if entry.customer_email else 'no email found' }}</td>
                                <td>{{ entry.customer_phone }}</td>
                                <td>{{ entry.customer_notes }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <button id="toggle-no-answer">No Answer</button>
            <div id="no-answer-list" style="display: none;">
                <div class="section-actions">
                    <button class="add-to-kvcore-btn" data-section="possible-leads">Add to KVCore</button>
                    <button class="delete-selected-btn" data-section="possible-leads">Delete</button>
                </div>
                <table border="1">
                    <thead>
                        <tr>
                            <th class="checkbox-column"><input type="checkbox" class="select-all" data-section="no_answer"></th>
                            <th>Customer Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in no_answer_entries %}
                            <tr>
                                <td><input type="checkbox" class="entry-checkbox" data-section="no_answer" data-entry-id="{{ entry.customer_id }}"></td>
                                <td>{{ entry.customer_name }}</td>
                                <td>{{ entry.customer_email if entry.customer_email else 'no email found' }}</td>
                                <td>{{ entry.customer_phone }}</td>
                                <td>{{ entry.customer_notes }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Leads Table -->
            <div class="table-container">
                <table id="basicInfoTable" class="display" style="display: none;">
                    <thead>
                        <tr>
                            <th>MLS</th>
                            <th>Status</th>
                            <th>Owner Phone</th>
                            <th>Owner Name</th>
                            <th>Owner Info</th>
                            <th>Prior Agent</th>
                            <th class="notes-column">Notes</th>
                            <th class="crm-column">Classify</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for listing in leads %}
                            {% if listing.Owner_Phone %}
                            <tr>
                                <td style="position: relative;">
                                    <span class="toggle mls-toggle" data-target="remarksDetails{{ loop.index }}">+</span>
                                    {{ listing.MLS }}
                                    <div class="remarks-content toggle-content" id="remarksDetails{{ loop.index }}" style="display: none;">
                                        <p>Remarks: {{ listing.Remarks }}</p>
                                    </div>
                                </td>
                                

                                <td>{{ listing.Status }}</td>
                                <td>{{ listing.Owner_Phone }}</td>

                                <td style="position: relative;">
                                    <span class="toggle owner-toggle" data-target="ownerNameDetails{{ loop.index }}">+</span>
                                    Owner Name
                                    <div class="owner-details toggle-content" id="ownerNameDetails{{ loop.index }}" style="display: none;">
                                        <p>Owner Name: {{ listing.Owner_Names }}</p>
                                        <p>First Name: {{ listing.Owner_First_Name }}</p>
                                        <p>Last Name: {{ listing.Owner_Last_Name }}</p>
                                    </div>
                                </td>

                                <td style="position: relative;">
                                    <span class="toggle owner-info-toggle" data-target="ownerInfoDetails{{ loop.index }}">+</span>
                                    Owner Info
                                    <div class="owner-info toggle-content" id="ownerInfoDetails{{ loop.index }}" style="display: none;">
                                        <p>Sale Amount: {{ listing.Sale_Amount }}</p>
                                        <p>List Price: {{ listing.List_Price }}</p>
                                        <p>Owner Occupied: {{ listing.Owner_Occupied }}</p>
                                        <p>Owner Address: {{ listing.Owner_Address }}</p>
                                    </div>
                                </td>

                                <td style="position: relative;">
                                    <span class="toggle prior-agent-toggle" data-target="priorAgentDetails{{ loop.index }}">+</span>
                                    Prior Agent Details
                                    <div class="prior-agent-details toggle-content" id="priorAgentDetails{{ loop.index }}" style="display: none;">
                                        <p>Agent Name: {{ listing.Agent_Name }}</p>
                                        <p>Office Name: {{ listing.Office_Name }}</p>
                                    </div>
                                </td>

                                <td class="notes-column">
                                    <button class="add-notes" data-mls="{{ listing.MLS }}">Notes</button>
                                    <div class="notes-input toggle-content" style="display: none;">
                                        <div class="buttons-container">
                                            <textarea id="notes-{{ listing.MLS }}" rows="2" placeholder="Enter your notes here..." class="notes-textarea"></textarea>
                                            <button class="save-notes" data-mls="{{ listing.MLS }}">Save</button>
                                            <button class="delete-notes" data-mls="{{ listing.MLS }}">Delete</button>
                                        </div>
                                    </div>
                                </td>

                                <td class="lead-classification">
                                    <div class="classification-buttons">
                                        <button class="classify-btn possible-lead-btn" data-mls="{{ listing.MLS }}" data-owner-names="{{ listing.Owner_Names }}" data-owner-phone="{{ listing.Owner_Phone }}" data-owner-email="{{ listing.Owner_Email if listing.Owner_Email else 'no email found' }}" data-section="possible_leads">
                                            Possible Lead
                                        </button>
                                        <button class="classify-btn no-lead-btn" data-mls="{{ listing.MLS }}" data-owner-names="{{ listing.Owner_Names }}" data-owner-phone="{{ listing.Owner_Phone }}" data-owner-email="{{ listing.Owner_Email if listing.Owner_Email else 'no email found' }}" data-section="no_leads">
                                            No Lead
                                        </button>
                                        <button class="classify-btn no-answer-btn" data-mls="{{ listing.MLS }}" data-owner-names="{{ listing.Owner_Names }}" data-owner-phone="{{ listing.Owner_Phone }}" data-owner-email="{{ listing.Owner_Email if listing.Owner_Email else 'no email found' }}" data-section="no_answer">
                                            No Answer
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>

    <!-- Script Section -->
    $(document).ready(function () {
        // DataTable initialization
        const table = $('#basicInfoTable').DataTable({
            pageLength: 10,
            responsive: true,
            initComplete: function () {
                $('#loader').hide();
                $('#basicInfoTable').show();
                $('.toggle-content').hide();
            }
        });
    
        // Section-specific checkbox and button handling (from previous solution)
        function updatePossibleLeadButtons() {
            const checkedCount = $('#possible-lead-list .entry-checkbox[data-section="possible_lead"]:checked').length;
            const hasSelection = checkedCount > 0;
            $('#possible-lead-list .add-to-kvcore-btn').prop('disabled', !hasSelection);
            $('#possible-lead-list .delete-selected-btn').prop('disabled', !hasSelection);
        }
    
        function updateNoLeadButtons() {
            const checkedCount = $('#no-lead-list .entry-checkbox[data-section="no_lead"]:checked').length;
            const hasSelection = checkedCount > 0;
            $('#no-lead-list .add-to-kvcore-btn').prop('disabled', !hasSelection);
            $('#no-lead-list .delete-selected-btn').prop('disabled', !hasSelection);
        }
    
        function updateNoAnswerButtons() {
            const checkedCount = $('#no-answer-list .entry-checkbox[data-section="no_answer"]:checked').length;
            const hasSelection = checkedCount > 0;
            $('#no-answer-list .add-to-kvcore-btn').prop('disabled', !hasSelection);
            $('#no-answer-list .delete-selected-btn').prop('disabled', !hasSelection);
        }
    
        function updatePossibleLeadSelectAll() {
            const totalCheckboxes = $('#possible-lead-list .entry-checkbox[data-section="possible_lead"]').length;
            const checkedCheckboxes = $('#possible-lead-list .entry-checkbox[data-section="possible_lead"]:checked').length;
            $('#possible-lead-list .select-all[data-section="possible_lead"]').prop('checked', 
                totalCheckboxes > 0 && totalCheckboxes === checkedCheckboxes
            );
            updatePossibleLeadButtons();
        }
    
        function updateNoLeadSelectAll() {
            const totalCheckboxes = $('#no-lead-list .entry-checkbox[data-section="no_lead"]').length;
            const checkedCheckboxes = $('#no-lead-list .entry-checkbox[data-section="no_lead"]:checked').length;
            $('#no-lead-list .select-all[data-section="no_lead"]').prop('checked', 
                totalCheckboxes > 0 && totalCheckboxes === checkedCheckboxes
            );
            updateNoLeadButtons();
        }
    
        function updateNoAnswerSelectAll() {
            const totalCheckboxes = $('#no-answer-list .entry-checkbox[data-section="no_answer"]').length;
            const checkedCheckboxes = $('#no-answer-list .entry-checkbox[data-section="no_answer"]:checked').length;
            $('#no-answer-list .select-all[data-section="no_answer"]').prop('checked', 
                totalCheckboxes > 0 && totalCheckboxes === checkedCheckboxes
            );
            updateNoAnswerButtons();
        }
    
        // Section visibility toggles
        $('#toggle-possible-lead').click(function() {
            const sectionList = $('#possible-lead-list');
            sectionList.toggle();
            $(this).text(sectionList.is(':visible') ? 
                'Hide possible lead' : 
                'Show possible lead'
            );
        });
    
        $('#toggle-no-lead').click(function() {
            const sectionList = $('#no-lead-list');
            sectionList.toggle();
            $(this).text(sectionList.is(':visible') ? 
                'Hide no lead' : 
                'Show no lead'
            );
        });
    
        $('#toggle-no-answer').click(function() {
            const sectionList = $('#no-answer-list');
            sectionList.toggle();
            $(this).text(sectionList.is(':visible') ? 
                'Hide no answer' : 
                'Show no answer'
            );
        });
    
        // Content toggles (MLS, Owner Info, Prior Agent)
        $('#basicInfoTable').on('click', '.toggle', function () {
            const target = $(this).data('target');
            const content = $('#' + target);
            content.toggle();
            $(this).text(content.is(':visible') ? '-' : '+');
        });
    
        // Notes handling
        function handleNotes(action, identifier, notes = null) {
            let url = '';
            const data = { [identifier.includes('@') ? 'email' : 'mls']: identifier };
    
            if (action === 'get') {
                url = identifier.includes('@') ? '/get_customer_notes' : '/get_notes';
                if (notes) data.notes = notes;
            } else if (action === 'save') {
                url = identifier.includes('@') ? '/save_customer_notes' : '/save_notes';
                data.notes = notes;
            } else if (action === 'delete') {
                url = identifier.includes('@') ? '/delete_customer_notes' : '/delete_notes';
            }
    
            $.ajax({
                url: url,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function (response) {
                    if (action === 'get' && response.notes) {
                        $(`#notes-${identifier}`).val(response.notes);
                    } else if (action === 'save') {
                        alert('Notes saved successfully');
                    } else if (action === 'delete') {
                        alert('Notes deleted successfully');
                    }
                },
                error: function () {
                    console.error(`Failed to ${action} notes.`);
                    alert(`Error ${action}ing notes`);
                }
            });
        }
    
        // Notes button handlers
        $('#basicInfoTable tbody').on('click', '.add-notes', function () {
            const mls = $(this).data('mls');
            const notesInput = $(this).siblings('.notes-input');
            notesInput.toggle();
    
            if (notesInput.is(':visible')) {
                handleNotes('get', mls);
            }
        });
    
        $('#basicInfoTable tbody').on('click', '.save-notes', function () {
            const mls = $(this).data('mls');
            const notes = $(`#notes-${mls}`).val();
            handleNotes('save', mls, notes);
        });
    
        $('#basicInfoTable tbody').on('click', '.delete-notes', function () {
            const mls = $(this).data('mls');
            if (confirm('Are you sure you want to delete these notes?')) {
                handleNotes('delete', mls);
                $(`#notes-${mls}`).val('');
            }
        });
    
        // Classification button handling
        $('.classify-btn').on('click', function () {
            const mls = $(this).data('mls');
            const ownerNames = $(this).data('owner-names');
            const ownerPhone = $(this).data('owner-phone');
            const ownerEmail = $(this).data('owner-email');
            const section = $(this).data('section');
    
            const data = {
                mls: mls,
                owner_names: ownerNames,
                owner_phone: ownerPhone,
                owner_email: ownerEmail,
                section: section
            };
    
            $.ajax({
                url: `/create_entry?section=${section}`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function (response) {
                    console.log('Entry saved successfully:', response);
                    alert(`Entry successfully added to ${section.replace('_', ' ')}`);
                },
                error: function () {
                    console.error('Error saving lead entry');
                    alert('Error saving entry');
                }
            });
        });
    
        // Form submission for generating new leads
        $('#leadsForm').on('submit', function(e) {
            e.preventDefault();
            $('#loader').show();
            $('#basicInfoTable').hide();
    
            $.ajax({
                url: $(this).attr('action'),
                method: 'GET',
                success: function(response) {
                    $('#loader').hide();
                    $('#basicInfoTable').show();
                    location.reload();
                },
                error: function() {
                    $('#loader').hide();
                    alert('Error generating leads');
                }
            });
        });
    
        // Event handlers for "Select All" checkboxes
        $('#possible-lead-list .select-all[data-section="possible_lead"]').on('change', function() {
            const isChecked = $(this).prop('checked');
            $('#possible-lead-list .entry-checkbox[data-section="possible_lead"]').prop('checked', isChecked);
            updatePossibleLeadButtons();
        });
    
        $('#no-lead-list .select-all[data-section="no_lead"]').on('change', function() {
            const isChecked = $(this).prop('checked');
            $('#no-lead-list .entry-checkbox[data-section="no_lead"]').prop('checked', isChecked);
            updateNoLeadButtons();
        });
    
        $('#no-answer-list .select-all[data-section="no_answer"]').on('change', function() {
            const isChecked = $(this).prop('checked');
            $('#no-answer-list .entry-checkbox[data-section="no_answer"]').prop('checked', isChecked);
            updateNoAnswerButtons();
        });
    
        // Event handlers for individual checkboxes
        $('#possible-lead-list .entry-checkbox[data-section="possible_lead"]').on('change', function() {
            updatePossibleLeadSelectAll();
        });
    
        $('#no-lead-list .entry-checkbox[data-section="no_lead"]').on('change', function() {
            updateNoLeadSelectAll();
        });
    
        $('#no-answer-list .entry-checkbox[data-section="no_answer"]').on('change', function() {
            updateNoAnswerSelectAll();
        });
    
        // Delete handlers for each section
        $('#possible-lead-list .delete-selected-btn').on('click', function() {
            const selectedIds = [];
            $('#possible-lead-list .entry-checkbox[data-section="possible_lead"]:checked').each(function() {
                selectedIds.push($(this).data('entry-id'));
            });
            handleDelete(selectedIds, 'possible_lead');
        });
    
        $('#no-lead-list .delete-selected-btn').on('click', function() {
            const selectedIds = [];
            $('#no-lead-list .entry-checkbox[data-section="no_lead"]:checked').each(function() {
                selectedIds.push($(this).data('entry-id'));
            });
            handleDelete(selectedIds, 'no_lead');
        });
    
        $('#no-answer-list .delete-selected-btn').on('click', function() {
            const selectedIds = [];
            $('#no-answer-list .entry-checkbox[data-section="no_answer"]:checked').each(function() {
                selectedIds.push($(this).data('entry-id'));
            });
            handleDelete(selectedIds, 'no_answer');
        });
    
        // KVCore handlers for each section
        $('#possible-lead-list .add-to-kvcore-btn').on('click', function() {
            const selectedIds = [];
            $('#possible-lead-list .entry-checkbox[data-section="possible_lead"]:checked').each(function() {
                selectedIds.push($(this).data('entry-id'));
            });
            handleKVCore(selectedIds, 'possible_lead');
        });
    
        $('#no-lead-list .add-to-kvcore-btn').on('click', function() {
            const selectedIds = [];
            $('#no-lead-list .entry-checkbox[data-section="no_lead"]:checked').each(function() {
                selectedIds.push($(this).data('entry-id'));
            });
            handleKVCore(selectedIds, 'no_lead');
        });
    
        $('#no-answer-list .add-to-kvcore-btn').on('click', function() {
            const selectedIds = [];
            $('#no-answer-list .entry-checkbox[data-section="no_answer"]:checked').each(function() {
                selectedIds.push($(this).data('entry-id'));
            });
            handleKVCore(selectedIds, 'no_answer');
        });
    
        function handleDelete(selectedIds, section) {
            alert('Selected IDs: ' + JSON.stringify(selectedIds));  // This will display the selected IDs in a readable format
            if (selectedIds.length > 0) {
                if (confirm(`Are you sure you want to delete ${selectedIds.length} selected entries?`)) {
                    $.ajax({
                        url: '/delete_entries',
                        method: 'POST',
                        data: JSON.stringify({ 
                            ids: selectedIds,
                            section: section
                        }),
                        contentType: 'application/json',
                        success: function(response) {
                            if (section === 'possible_lead') updatePossibleLeadSelectAll();
                            else if (section === 'no_lead') updateNoLeadSelectAll();
                            else if (section === 'no_answer') updateNoAnswerSelectAll();
                            alert('Entries deleted successfully');
                        },
                        error: function() {
                            alert('Error deleting entries');
                        }
                    });
                }
            } else {
                alert('Please select entries to delete');
            }
        }
    
        function handleKVCore(selectedIds, section) {
            alert('Selected IDs: ' + JSON.stringify(selectedIds));  // This will display the selected IDs in a readable format
            if (selectedIds.length > 0) {
                if (confirm(`Add ${selectedIds.length} selected entries to KVCore?`)) {
                    $.ajax({
                        url: '/add_to_kvcore',
                        method: 'POST',
                        data: JSON.stringify({ 
                            ids: selectedIds,
                            section: section
                        }),
                        contentType: 'application/json',
                        success: function(response) {
                            $(`#${section}-list .entry-checkbox[data-section="${section}"]`).prop('checked', false);
                            if (section === 'possible_lead') updatePossibleLeadSelectAll();
                            else if (section === 'no_lead') updateNoLeadSelectAll();
                            else if (section === 'no_answer') updateNoAnswerSelectAll();
                            alert('Successfully added to KVCore');
                        },
                        error: function() {
                            alert('Error adding to KVCore');
                        }
                    });
                }
            } else {
                alert('Please select entries to add to KVCore');
            }
        }
    
        // Initialize button states on page load
        updatePossibleLeadButtons();
        updateNoLeadButtons();
        updateNoAnswerButtons();
    });
   </script>
</body>
</html>