<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Listings</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="static/css/leads_tab1.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
</head>
<body>
    <div class="loader" id="loader">
        <div class="spinner"></div>
        <div class="loading-message"><br>Retrieving leads...</div>    
    </div>

    <div class="container">
        <h1 class="banner">LEADTOOLS</h1>

        <div id="tab1" class="tab-content active">
            <form id="leadsForm" action="/api/populate_leads_database" method="get">
                <button class="get" type="submit" id="startButton">Generate New Leads</button>
            </form>

            <div id="timer" style="font-size: 12px; margin-top: 10px;"></div>

            <button id="toggle-possible-lead">Possible Lead</button>
            <div id="possible-lead-list" style="display: none;">
                <table border="1">
                    <thead>
                        <tr>
                            <th>Customer Name</th>
                            <th>Email</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in possible_entries %}
                            <tr>
                                <td>{{ entry.customer_name }}</td>
                                <td>{{ entry.customer_email }}</td>
                                <td>{{ entry.customer_notes }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <button id="toggle-no-lead">No Lead</button>
            <div id="no-lead-list" style="display: none;">
                <table border="1">
                    <thead>
                        <tr>
                            <th>Customer Name</th>
                            <th>Email</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in no_answer_entries %}
                            <tr>
                                <td>{{ entry.customer_name }}</td>
                                <td>{{ entry.customer_email }}</td>
                                <td>{{ entry.customer_notes }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <button id="toggle-no-answer">No Answer</button>
            <div id="no-answer-list" style="display: none;">
                <table border="1">
                    <thead>
                        <tr>
                            <th>Customer Name</th>
                            <th>Email</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for entry in no_answer_entries %}
                            <tr>
                                <td>{{ entry.customer_name }}</td>
                                <td>{{ entry.customer_email }}</td>
                                <td>{{ entry.customer_notes }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <div class="table-container">
                <table id="basicInfoTable" class="display" style="display: none;">
                    <thead>
                        <tr>
                            <th>MLS</th>
                            <th>Status</th>
                            <th>Owner Phone</th>
                            <th>Owner Name</th>
                            <th>Owner Info</th>
                            <th>Prior Agent</th>
                            <th class="notes-column">Notes</th>
                            <th class="crm-column">Classify</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for listing in leads %}
                            {% if listing.Owner_Phone %}
                            <tr>
                                <td style="position: relative;">
                                    <span class="toggle mls-toggle" data-target="remarksDetails{{ loop.index }}">+</span>
                                    {{ listing.MLS }}
                                    <div class="remarks-content toggle-content" id="remarksDetails{{ loop.index }}" style="display: none;">
                                        <p>Remarks: {{ listing.Remarks }}</p>
                                    </div>
                                </td>
                                <td>{{ listing.Status }}</td>
                                <td>{{ listing.Owner_Phone }}</td>
                                <td style="position: relative;">
                                    <span class="toggle owner-toggle" data-target="ownerNameDetails{{ loop.index }}">+</span>
                                    Owner Name
                                    <div class="owner-details toggle-content" id="ownerNameDetails{{ loop.index }}" style="display: none;">
                                        <p>Owner Name: {{ listing.Owner_Names }}</p>
                                        <p>First Name: {{ listing.Owner_First_Name }}</p>
                                        <p>Last Name: {{ listing.Owner_Last_Name }}</p>
                                    </div>
                                </td>
                                <td style="position: relative;">
                                    <span class="toggle owner-info-toggle" data-target="ownerInfoDetails{{ loop.index }}">+</span>
                                    Owner Info
                                    <div class="owner-info toggle-content" id="ownerInfoDetails{{ loop.index }}" style="display: none;">
                                        <p>Sale Amount: {{ listing.Sale_Amount }}</p>
                                        <p>List Price: {{ listing.List_Price }}</p>
                                        <p>Owner Occupied: {{ listing.Owner_Occupied }}</p>
                                        <p>Owner Address: {{ listing.Owner_Address }}</p>
                                    </div>
                                </td>
                                <td style="position: relative;">
                                    <span class="toggle prior-agent-toggle" data-target="priorAgentDetails{{ loop.index }}">+</span>
                                    Prior Agent Details
                                    <div class="prior-agent-details toggle-content" id="priorAgentDetails{{ loop.index }}" style="display: none;">
                                        <p>Agent Name: {{ listing.Agent_Name }}</p>
                                        <p>Office Name: {{ listing.Office_Name }}</p>
                                    </div>
                                </td>
                                <td class="notes-column">
                                    <button class="add-notes" data-mls="{{ listing.MLS }}">Notes</button>
                                    <div class="notes-input toggle-content" style="display: none;">
                                        <div class="buttons-container">
                                            <textarea id="notes-{{ listing.MLS }}" rows="2" placeholder="Enter your notes here..." class="notes-textarea"></textarea>
                                            <button class="save-notes" data-mls="{{ listing.MLS }}">Save</button>
                                            <button class="delete-notes" data-mls="{{ listing.MLS }}">Delete</button>
                                        </div>
                                    </div>
                                </td>
                                <td class="lead-classification">
                                    <div class="classification-buttons">
                                        <button 
                                            class="classify-btn possible-lead-btn" 
                                            mls="{{ listing.MLS }}" 
                                            owner-names="{{ listing.Owner_Names }}"
                                            owner-phone="{{ listing.Owner_Phone }}"
                                            section="possible_lead">
                                            Possible Lead
                                        </button>
                                        <button 
                                            class="classify-btn no-lead-btn" 
                                            mls="{{ listing.MLS }}" 
                                            owner-names="{{ listing.Owner_Names }}"
                                            owner-phone="{{ listing.Owner_Phone }}"
                                            section="no_lead">
                                            No Lead
                                        </button>
                                        <button 
                                            class="classify-btn no-answer-btn" 
                                            mls="{{ listing.MLS }}" 
                                            owner-names="{{ listing.Owner_Names }}"
                                            owner-phone="{{ listing.Owner_Phone }}"
                                            section="no_answer">
                                            No-Answer
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>

                <script>
                    $(document).ready(function () {
                        const table = $('#basicInfoTable').DataTable({
                            pageLength: 10,
                            responsive: true,
                            initComplete: function () {
                                $('#loader').hide();
                                $('#basicInfoTable').show();
                                $('.toggle-content').hide();
                            }
                        });

                        // Toggle Remark Details
                        $('#basicInfoTable').on('click', '.mls-toggle', function() {
                            const targetId = $(this).data('target');
                            $(`#${targetId}`).toggle();
                            const sign = $(`#${targetId}`).is(':visible') ? '-' : '+';
                            $(this).text(sign);
                        });

                        // Toggle Owner Name Details
                        $('#basicInfoTable').on('click', '.owner-toggle', function() {
                            const targetId = $(this).data('target');
                            $(`#${targetId}`).toggle();
                            const sign = $(`#${targetId}`).is(':visible') ? '-' : '+';
                            $(this).text(sign);
                        });

                        // Toggle Owner Info Details
                        $('#basicInfoTable').on('click', '.owner-info-toggle', function() {
                            const targetId = $(this).data('target');
                            $(`#${targetId}`).toggle();
                            const sign = $(`#${targetId}`).is(':visible') ? '-' : '+';
                            $(this).text(sign);
                        });

                        // Toggle Prior Agent Details
                        $('#basicInfoTable').on('click', '.prior-agent-toggle', function() {
                            const targetId = $(this).data('target');
                            $(`#${targetId}`).toggle();
                            const sign = $(`#${targetId}`).is(':visible') ? '-' : '+';
                            $(this).text(sign);
                        });

                        // Lead Classification Handler
                        $('#basicInfoTable').on('click', '.classify-btn', function(e) {
                            const button = $(this);
                            const mls = button.attr('mls');
                            const ownerNames = button.attr('owner-names');
                            const ownerPhone = button.attr('owner-phone');
                            const section = button.attr('section');

                            // Show alert for demonstration
                            alert(`Lead classified as ${section}`);

                            // Optional: send this data to backend for classification update
                            $.post('/api/update_lead_status', { mls, section });

                            // Prevent multiple submissions
                            button.prop('disabled', true);
                            setTimeout(() => button.prop('disabled', false), 2000); // Re-enable after 2 seconds
                        });

                        
                        Z
                        // Notes functionality
                        $('#basicInfoTable').on('click', '.add-notes', function() {
                            const mls = $(this).data('mls');
                            const notesInput = $(this).siblings('.notes-input');
                            notesInput.toggle();
                            if (notesInput.is(':visible')) {
                                $.post('/get_notes', { mls }, function(response) {
                                    $(`#notes-${mls}`).val(response.notes);
                                });
                            }
                        });

                        $('#basicInfoTable').on('click', '.save-notes', function() {
                            const mls = $(this).data('mls');
                            const notes = $(`#notes-${mls}`).val();
                            $.post('/save_notes', { mls, notes }, function() {
                                alert('Notes saved');
                            });
                        });

                        $('#basicInfoTable').on('click', '.delete-notes', function() {
                            const mls = $(this).data('mls');
                            $.post('/delete_notes', { mls }, function() {
                                $(`#notes-${mls}`).val('');
                                alert('Notes deleted');
                            });
                        });
                    });
                </script>
            </div>
        </div>
    </div>
</body>
</html>
